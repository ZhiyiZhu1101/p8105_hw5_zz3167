---
title: "p8105_hw5_zz3167"
author: "Zhiyi Zhu"
date: "2023-11-08"
output: github_document
---

```{r setup, message = FALSE}
library(tidyverse)
library(broom)

knitr::opts_chunk$set(
  fig.width = 15,
  fig.asp = .6,
  dpi = 200,
  out.width = "90%",
  message = FALSE, 
  warning = FALSE
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

```

## Problem 1

### Import data
```{r}
homicides_data = 
  read_csv("data/homicide-data.csv") |>
  janitor::clean_names()
```

### Describe the raw data 

* The data set contains `r nrow(homicides_data)` observations of `r ncol(homicides_data)` variables, which shows the details of homicides in 50 large U.S. cities.
* The data set includes the reported date of homicides, the victims' personal information, the location and disposition of the homicides. 

```{r}
# create a city_state variable
homicides_data =
  homicides_data |>
  mutate(city_state = paste(city,',',state))

# summarize within cities to obtain the total number of homicides and the number of unsolved homicides 
homicides_number = 
  homicides_data |>
  group_by(city_state) |>
  summarise(
    total_homicides = n(),
    unsolved_homicides = sum(disposition %in% c("Closed without arrest","Open/No arrest"))
    )

print(homicides_number)
```

### Estimate the proportion of homicides

```{r}
# estimate the proportion of homicides of Baltimore,MD
baltimore_df = 
  homicides_number |>
  filter(city_state == "Baltimore , MD")

baltimore_result  =
  prop.test(x = pull(baltimore_df, unsolved_homicides), 
            n = pull(baltimore_df, total_homicides),
            alternative = "two.sided",
            conf.level = 0.95, 
            correct = TRUE)|>
  broom::tidy()

baltimore_result

# save the output of prop.test as an R object
save(baltimore_result, file = "result/baltimore_result.RData")

# pull the estimated proportion and confidence intervals from the resulting tidy dataframe
baltimore_tidy = 
data.frame(
  city = 'Baltimore, MD',
  estimate = pull(baltimore_result, estimate),
  ci_lower = pull(baltimore_result, conf.low),
  ci_upper = pull(baltimore_result, conf.high)
) 

print(baltimore_tidy)
```

So, the estimated proportion is `r baltimore_tidy |> pull(estimate) |> round(3)`. The 95% confidence interval is `r paste('(', baltimore_tidy |> pull(ci_lower) |>round(3), ',', baltimore_tidy |> pull(ci_upper) |> round(3), ')')`

### Run prop.test for each of the cities

```{r}
unsolved_propotion = function(city_name) {
  city_number = 
    homicides_number |>
    filter(city_state == city_name)
  
  city_result = 
    prop.test(x = pull(city_number, unsolved_homicides), 
              n = pull(city_number, total_homicides)) |>
    broom::tidy() |>
    select(estimate, conf.low, conf.high)
  
  city_result
}

city_name = pull(homicides_number, city_state)

total_result = 
  data_frame(city_name) |>
  mutate(test_result = map(city_name, unsolved_propotion)) |>
  unnest(test_result)
  
total_result
```

### Create a plot that shows the estimates and CIs for each city

```{r}
total_result |>
  arrange(estimate) |>
  ggplot(aes(x = city_name, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 45, size = 6))+
  labs(x = "City", 
       y = "Estimate and 95% CI", 
       title = "Estimates and Confidence Intervals for Unsolved Homicides by City")
```











